<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Global Matrix Room</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: 'Courier New', monospace; }
        canvas { display: block; }

        /* ERROR LOG */
        #debug-log {
            position: absolute; top: 0; left: 0; width: 100%; background: rgba(200,0,0,0.8);
            color: white; font-size: 14px; padding: 5px; pointer-events: none; z-index: 999; display: none;
        }

        /* LOGIN SCREEN */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #0f0;
        }
        h1 { text-shadow: 0 0 10px #0f0; }
        input { padding: 15px; font-size: 18px; text-align: center; margin-bottom: 20px; border: 2px solid #0f0; background: #111; color: #0f0; border-radius: 5px; }
        button#join-btn { padding: 15px 40px; background: #0f0; border: none; font-weight: bold; font-size: 20px; cursor: pointer; border-radius: 5px; box-shadow: 0 0 15px #0f0; }
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Global Matrix Room</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: 'Courier New', monospace; }
        canvas { display: block; }

        /* ERROR LOG */
        #debug-log {
            position: absolute; top: 0; left: 0; width: 100%; background: rgba(200,0,0,0.8);
            color: white; font-size: 14px; padding: 5px; pointer-events: none; z-index: 999; display: none;
        }

        /* LOGIN SCREEN */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #0f0;
        }
        h1 { text-shadow: 0 0 10px #0f0; }
        input { padding: 15px; font-size: 18px; text-align: center; margin-bottom: 20px; border: 2px solid #0f0; background: #111; color: #0f0; border-radius: 5px; }
        button#join-btn { padding: 15px 40px; background: #0f0; border: none; font-weight: bold; font-size: 20px; cursor: pointer; border-radius: 5px; box-shadow: 0 0 15px #0f0; }

        /* GAME UI */
        #ui-layer { position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none; z-index: 10; }
        #timer { font-size: 50px; color: #fff; font-weight: bold; display: none; text-shadow: 0 0 10px #000; }
        #status { font-size: 16px; color: #aaa; background: rgba(0,0,0,0.6); display: inline-block; padding: 5px 15px; border-radius: 20px; }

        /* CLAP BUTTON */
        #clap-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 25px 60px; font-size: 25px; background: #0f0; border: 5px solid #fff;
            border-radius: 50px; cursor: pointer; display: none; z-index: 50;
            box-shadow: 0 0 30px #0f0; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: translate(-50%,-50%) scale(1); } 50% { transform: translate(-50%,-50%) scale(1.1); } }

        /* CONTROLS */
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px; border: 2px solid rgba(0,255,0,0.3); border-radius: 50%; touch-action: none; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; background: rgba(0,255,0,0.6); border-radius: 50%; transform: translate(-50%,-50%); pointer-events: none; }
        #look-hint { position: absolute; bottom: 40px; right: 40px; color: #0f0; border: 1px solid #0f0; padding: 10px; background: rgba(0,0,0,0.5); pointer-events: none; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="debug-log"></div>

    <div id="login-screen">
        <h1>GLOBAL ROOM</h1>
        <input type="text" id="username" placeholder="ENTER NAME" maxlength="8">
        <button id="join-btn">JOIN NOW</button>
    </div>

    <div id="ui-layer">
        <div id="timer">00:30</div>
        <div id="status">WAITING FOR PLAYERS...</div>
    </div>

    <button id="clap-btn">üëè CLAP NOW üëè</button>

    <div id="joystick-zone"><div id="joystick-knob"></div></div>
    <div id="look-hint">DRAG RIGHT SIDE TO LOOK</div>

    <!-- LIBRARIES -->
    <script type="importmap">
        { "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }}
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc } from 'firebase/firestore';

        // --- YOUR CONFIG (ALREADY INSERTED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBwEhCK0dpslmSHdL6OsAqJUM7ZUmtLqvU",
            authDomain: "toyou-a80b2.firebaseapp.com",
            projectId: "toyou-a80b2",
            storageBucket: "toyou-a80b2.appspot.com",
            messagingSenderId: "77162611167",
            appId: "1:77162611167:web:3dc6d01aa9dcd4bdc0046a"
        };

        // DEBUGGER
        function showError(msg) {
            const d = document.getElementById('debug-log');
            d.style.display = 'block';
            d.innerText = "ERROR: " + msg;
            if(msg.includes("permission")) d.innerText += " (CHECK FIREBASE RULES!)";
        }

        // INIT FIREBASE
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch(e) { showError(e.message); }

        // --- GAME VARIABLES ---
        const myId = 'p_' + Math.random().toString(36).substr(2, 9);
        let myName = "Anon";
        let isPlaying = false;
        let players = {};
        let isMatrix = false;
        let wallMeshes = [];
        let startTime = null;

        // --- SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // LIGHTS
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.PointLight(0xffffff, 0.8, 200);
        light.position.set(0, 50, 0);
        scene.add(light);

        // --- TEXTURES ---
        function createNumTex(n) {
            const c = document.createElement('canvas'); c.width=128; c.height=128;
            const x = c.getContext('2d');
            x.fillStyle='#ddd'; x.fillRect(0,0,128,128);
            x.fillStyle='#000'; x.font='50px Arial'; x.textAlign='center'; x.textBaseline='middle';
            x.fillText(n, 64, 64);
            x.strokeStyle='#555'; x.lineWidth=4; x.strokeRect(0,0,128,128);
            return new THREE.CanvasTexture(c);
        }

        function createMatrixTex() {
            const c = document.createElement('canvas'); c.width=256; c.height=256;
            const x = c.getContext('2d');
            x.fillStyle='#000'; x.fillRect(0,0,256,256);
            x.fillStyle='#0f0'; x.font='20px monospace';
            for(let i=0; i<60; i++) x.fillText(String.fromCharCode(0x30A0+Math.random()*96), Math.random()*256, Math.random()*256);
            return new THREE.CanvasTexture(c);
        }
        const matrixTex = createMatrixTex();

        // --- BUILD ROOM ---
        const ROOM_SIZE = 400; 
        let count = 1;
        
        function makeWall(w, h, px, py, pz, rx, ry) {
            const g = new THREE.Group();
            g.position.set(px, py, pz); g.rotation.set(rx, ry, 0);
            const cols = w/50, rows = h/50;
            const sx = -w/2, sy = -h/2;
            
            for(let c=0; c<cols; c++) {
                for(let r=0; r<rows; r++) {
                    const mesh = new THREE.Mesh(
                        new THREE.PlaneGeometry(50,50),
                        new THREE.MeshStandardMaterial({ map: createNumTex(count++) })
                    );
                    mesh.position.set(sx + c*50 + 25, sy + r*50 + 25, 0);
                    wallMeshes.push(mesh);
                    g.add(mesh);
                }
            }
            scene.add(g);
        }

        // Floor/Ceiling
        makeWall(400, 400, 0, -60, 0, -Math.PI/2, 0);
        makeWall(400, 400, 0, 60, 0, Math.PI/2, 0);
        // Walls
        makeWall(400, 120, 0, 0, -200, 0, 0); // Front
        makeWall(400, 120, 0, 0, 200, 0, Math.PI); // Back
        makeWall(400, 120, -200, 0, 0, 0, Math.PI/2); // Left
        makeWall(400, 120, 200, 0, 0, 0, -Math.PI/2); // Right

        // --- LOGIC ---
        
        // 1. Start Button
        document.getElementById('join-btn').addEventListener('click', () => {
            const name = document.getElementById('username').value;
            if(!name) return alert("ENTER NAME");
            myName = name;
            document.getElementById('login-screen').style.display = 'none';
            isPlaying = true;
            initGame();
        });

        // 2. Init Multiplayer
        const gameDocRef = doc(db, "gamestate", "global_room");
        const playersRef = collection(db, "players_global");

        function initGame() {
            // A. Listen to Game State (Timer/Matrix)
            onSnapshot(gameDocRef, (snap) => {
                if(!snap.exists()) {
                    // Create default state if missing
                    setDoc(gameDocRef, { start: null, matrix: false }).catch(e => showError(e.message));
                    return;
                }
                const d = snap.data();
                
                // Matrix Trigger
                if(d.matrix && !isMatrix) {
                    isMatrix = true;
                    wallMeshes.forEach(m => {
                        m.material.map = matrixTex;
                        m.material.color.setHex(0x00ff00);
                        m.material.needsUpdate = true;
                    });
                    document.getElementById('clap-btn').style.display = 'none';
                    document.getElementById('timer').style.color = '#0f0';
                    document.getElementById('timer').innerText = "HACKED";
                }

                // Timer Trigger
                if(d.start) {
                    startTime = d.start;
                    document.getElementById('timer').style.display = 'block';
                }
            }, error => showError(error.message));

            // B. Listen to Players
            onSnapshot(playersRef, (snap) => {
                const now = Date.now();
                let pCount = 0;

                snap.forEach(d => {
                    const data = d.data();
                    if(now - data.time > 8000) return; // Skip ghosts
                    
                    pCount++;
                    if(d.id === myId) return; // Skip self

                    // Update/Create Avatar
                    if(!players[d.id]) {
                        const g = new THREE.Group();
                        const b = new THREE.Mesh(new THREE.CapsuleGeometry(5,15,4,8), new THREE.MeshStandardMaterial({color:0xff0000}));
                        g.add(b);
                        // Name
                        const cv = document.createElement('canvas'); cv.width=256; cv.height=64;
                        const cx=cv.getContext('2d'); cx.font="30px Arial"; cx.fillStyle="white"; cx.textAlign="center"; cx.fillText(data.name,128,40);
                        const s=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(cv)}));
                        s.position.y=20; s.scale.set(20,5,1); g.add(s);
                        
                        g.position.set(data.x, data.y, data.z);
                        scene.add(g);
                        players[d.id] = g;
                    } else {
                        players[d.id].position.set(data.x, data.y, data.z);
                        players[d.id].rotation.y = data.ry;
                    }
                });

                // Remove disconnected
                for(let id in players) {
                    if(!snap.docs.find(doc => doc.id === id)) {
                        scene.remove(players[id]); delete players[id];
                    }
                }

                document.getElementById('status').innerText = `PLAYERS ONLINE: ${pCount}`;

                // Trigger Timer if 2 players and not started
                if(pCount >= 2 && !startTime && isPlaying) {
                    updateDoc(gameDocRef, { start: Date.now() }).catch(e=>{}); 
                }
            });

            // C. Send My Pos
            setInterval(() => {
                if(isPlaying) {
                    setDoc(doc(db, "players_global", myId), {
                        x: camera.position.x, y: camera.position.y-10, z: camera.position.z,
                        ry: camera.rotation.y, name: myName, time: Date.now()
                    }).catch(e => showError(e.message));
                }
            }, 100);
        }

        // 3. Clap Logic
        document.getElementById('clap-btn').addEventListener('click', () => {
            updateDoc(gameDocRef, { matrix: true });
        });

        // --- INPUTS ---
        camera.position.set(0,0,100);
        let move = {x:0, y:0};
        let joyId = null;
        const joyZone = document.getElementById('joystick-zone');
        const joyKnob = document.getElementById('joystick-knob');

        const handleJoy = (cx, cy) => {
            const r = joyZone.getBoundingClientRect();
            let dx = cx - (r.left+70), dy = cy - (r.top+70);
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 60);
            const ang = Math.atan2(dy, dx);
            dx = Math.cos(ang)*dist; dy = Math.sin(ang)*dist;
            joyKnob.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            move.x = dx/60; move.y = dy/60;
        };

        joyZone.addEventListener('touchstart', e=>{ e.preventDefault(); joyId=e.changedTouches[0].identifier; handleJoy(e.changedTouches[0].clientX, e.changedTouches[0].clientY); }, {passive:false});
        joyZone.addEventListener('touchmove', e=>{ e.preventDefault(); for(let t of e.changedTouches) if(t.identifier===joyId) handleJoy(t.clientX, t.clientY); }, {passive:false});
        joyZone.addEventListener('touchend', e=>{ for(let t of e.changedTouches) if(t.identifier===joyId) { joyId=null; move={x:0,y:0}; joyKnob.style.transform='translate(-50%,-50%)'; } });

        // Look
        let lookId=null, prevLook={x:0,y:0};
        document.addEventListener('touchstart', e=>{
            for(let t of e.changedTouches) if(t.identifier!==joyId && e.target.id!=='clap-btn') { lookId=t.identifier; prevLook={x:t.clientX, y:t.clientY}; }
        }, {passive:false});
        document.addEventListener('touchmove', e=>{
            for(let t of e.changedTouches) if(t.identifier===lookId) {
                camera.rotation.y -= (t.clientX - prevLook.x)*0.005;
                camera.rotation.x -= (t.clientY - prevLook.y)*0.005;
                prevLook={x:t.clientX, y:t.clientY};
            }
        }, {passive:false});

        // --- ANIMATION ---
        function animate() {
            requestAnimationFrame(animate);
            
            // Move
            if(move.x!==0 || move.y!==0) {
                const d = new THREE.Vector3(move.x, 0, move.y).applyAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y);
                camera.position.addScaledVector(d, 3.5);
                
                // Boundaries
                const LIM = 180;
                camera.position.x = Math.max(-LIM, Math.min(LIM, camera.position.x));
                camera.position.z = Math.max(-LIM, Math.min(LIM, camera.position.z));
            }

            // Timer
            if(startTime && !isMatrix) {
                const elap = Date.now() - startTime;
                const rem = Math.ceil((30000 - elap)/1000);
                if(rem > 0) document.getElementById('timer').innerText = "00:" + (rem<10?'0':'')+rem;
                else {
                    document.getElementById('timer').innerText = "TIME UP";
                    document.getElementById('clap-btn').style.display = 'block';
                }
            }

            // Matrix
            if(isMatrix) matrixTex.offset.y -= 0.015;

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('beforeunload', ()=>deleteDoc(doc(db, "players_global", myId)));

    </script>
</body>
</html>
