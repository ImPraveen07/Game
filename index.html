<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matrix Master</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: monospace; }
        
        /* DIAGNOSTIC BOX (Yellow Text) */
        #debug-overlay {
            position: absolute; top: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.8); color: yellow; font-size: 12px; 
            padding: 5px; pointer-events: none; z-index: 9999;
            white-space: pre-wrap; border-bottom: 1px solid yellow;
        }

        /* CONNECTION DOT */
        #status-dot {
            position: absolute; top: 40px; left: 15px; width: 15px; height: 15px;
            background: red; border-radius: 50%; z-index: 1000; box-shadow: 0 0 10px red;
        }

        /* LOGIN */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        input { padding: 15px; font-size: 20px; text-align: center; background: #000; border: 2px solid #0f0; color: #0f0; margin-bottom: 20px; }
        button { padding: 15px 50px; background: #0f0; border: none; font-weight: bold; font-size: 18px; cursor: pointer; }

        /* UI */
        #ui-layer { position: absolute; top: 40px; width: 100%; text-align: center; pointer-events: none; z-index: 50; }
        #timer { font-size: 50px; color: #fff; font-weight: bold; display: none; text-shadow: 0 0 10px #000; }
        
        /* CLAP BUTTON */
        #clap-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 25px 50px; font-size: 25px; font-weight: bold;
            background: #0f0; border: 5px solid #fff; border-radius: 50px;
            display: none; z-index: 60; cursor: pointer;
        }

        /* CONTROLS */
        #zone-move { position: absolute; bottom: 0; left: 0; width: 50%; height: 100%; z-index: 10; }
        #zone-look { position: absolute; bottom: 0; right: 0; width: 50%; height: 100%; z-index: 10; }
        #joy-base {
            position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px;
            border: 2px solid rgba(0,255,0,0.3); border-radius: 50%; pointer-events: none; z-index: 5;
        }
        #joy-stick {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: rgba(0,255,0,0.5); border-radius: 50%; transform: translate(-50%,-50%);
        }
    </style>
</head>
<body>

    <div id="debug-overlay">initializing...</div>
    <div id="status-dot"></div>

    <div id="login-screen">
        <h1 style="color:#0f0; text-shadow:0 0 10px #0f0">MATRIX LOGIN</h1>
        <input type="text" id="username" placeholder="USERNAME" maxlength="10">
        <button id="join-btn">JOIN</button>
    </div>

    <div id="ui-layer">
        <div id="timer">00:30</div>
    </div>

    <button id="clap-btn">üëè HACK üëè</button>

    <div id="zone-move"></div>
    <div id="zone-look"></div>
    <div id="joy-base"><div id="joy-stick"></div></div>

    <script type="importmap">
        { "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }}
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc } from 'firebase/firestore';

        // 1. DEBUGGER
        const debugBox = document.getElementById('debug-overlay');
        function log(msg) { debugBox.innerText = msg + "\n" + debugBox.innerText.substring(0, 100); }
        
        // 2. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBwEhCK0dpslmSHdL6OsAqJUM7ZUmtLqvU",
            authDomain: "toyou-a80b2.firebaseapp.com",
            projectId: "toyou-a80b2",
            storageBucket: "toyou-a80b2.appspot.com",
            messagingSenderId: "77162611167",
            appId: "1:77162611167:web:3dc6d01aa9dcd4bdc0046a"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            log("Firebase Init OK");
        } catch(e) { log("FIREBASE ERROR: " + e.message); }

        // 3. VARS
        const myId = 'u_' + Math.floor(Math.random()*100000);
        let myName = "Anon";
        let isPlaying = false;
        let isMatrix = false;
        let startTime = null;
        let otherPlayers = {}; // { id: { mesh, targetPos, targetRot } }

        // 4. SCENE
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xaaaaaa);
        scene.fog = new THREE.Fog(0xaaaaaa, 10, 400);

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const pl = new THREE.PointLight(0xffffff, 0.5, 300); pl.position.set(0,100,0); scene.add(pl);

        // 5. MATRIX SHADER
        const matUniforms = { iTime: { value: 0 } };
        const matMaterial = new THREE.ShaderMaterial({
            uniforms: matUniforms,
            vertexShader: `varying vec2 vUv; void main(){vUv=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
            fragmentShader: `varying vec2 vUv; uniform float iTime;
            float rand(vec2 c){return fract(sin(dot(c.xy,vec2(12.9898,78.233)))*43758.5453);}
            void main(){
                vec2 u=vUv; u.x*=50.0; vec2 i=floor(u); vec2 f=fract(u);
                float s=2.0+rand(vec2(i.x,0.0))*3.0; float y=f.y+iTime*s;
                float c=step(0.5,rand(vec2(i.x,floor(y*20.0))));
                float t=1.0-fract(y); t=pow(t,3.0);
                vec3 col=vec3(0.,1.,0.)*t*c; if(t>0.9&&c>0.5)col=vec3(0.8,1.0,0.8);
                gl_FragColor=vec4(col,1.0);
            }`, side: THREE.DoubleSide
        });

        // 6. ROOM
        const walls = [];
        function build(w,h,p,r) {
            const g = new THREE.PlaneGeometry(w,h);
            const m = new THREE.Mesh(g, new THREE.MeshStandardMaterial({color:0xdddddd}));
            m.position.copy(p); m.rotation.set(r.x,r.y,r.z);
            scene.add(m); walls.push(m);
        }
        build(400,400, new THREE.Vector3(0,-50,0), new THREE.Vector3(-Math.PI/2,0,0));
        build(400,400, new THREE.Vector3(0,100,0), new THREE.Vector3(Math.PI/2,0,0));
        build(400,150, new THREE.Vector3(0,25,-200), new THREE.Vector3(0,0,0));
        build(400,150, new THREE.Vector3(0,25,200), new THREE.Vector3(0,Math.PI,0));
        build(400,150, new THREE.Vector3(-200,25,0), new THREE.Vector3(0,Math.PI/2,0));
        build(400,150, new THREE.Vector3(200,25,0), new THREE.Vector3(0,-Math.PI/2,0));

        // 7. NETWORK LOGIC
        document.getElementById('join-btn').addEventListener('click', () => {
            const n = document.getElementById('username').value;
            if(!n) return alert("Name needed");
            myName = n;
            document.getElementById('login-screen').style.display='none';
            isPlaying=true;
            connect();
        });

        function connect() {
            // !! IMPORTANT: USING A NEW COLLECTION NAME TO ENSURE FRESH CONNECT !!
            const roomName = "room_master_final";
            const colName = "players_master_final";

            log("Connecting to " + colName + "...");

            const gameRef = doc(db, "gamestate", roomName);
            const playerRef = collection(db, colName);

            // A. GAME STATE
            onSnapshot(gameRef, (snap) => {
                document.getElementById('status-dot').style.background="#0f0";
                if(!snap.exists()) { setDoc(gameRef, {start:null, matrix:false}); return; }
                const d = snap.data();
                
                if(d.matrix && !isMatrix) {
                    isMatrix=true;
                    walls.forEach(w => w.material = matMaterial);
                    scene.background = new THREE.Color(0x000000);
                    document.getElementById('clap-btn').style.display='none';
                    document.getElementById('timer').innerText="HACKED";
                    document.getElementById('timer').style.color="#0f0";
                }
                if(d.start) {
                    startTime = d.start;
                    document.getElementById('timer').style.display='block';
                }
            });

            // B. PLAYERS
            onSnapshot(playerRef, (snap) => {
                const now = Date.now();
                let count = 0;
                
                snap.forEach(docSnap => {
                    const p = docSnap.data();
                    // Debug: Log who we see
                    // log("Found: " + p.name);

                    if(now - p.time > 10000) return; // Ignore old
                    count++;

                    if(docSnap.id === myId) return;

                    if(!otherPlayers[docSnap.id]) {
                        // New Player
                        const g = new THREE.Group();
                        const b = new THREE.Mesh(new THREE.CapsuleGeometry(6,20,4,8), new THREE.MeshStandardMaterial({color:0x333333}));
                        g.add(b);
                        
                        // Name
                        const c=document.createElement('canvas'); c.width=256; c.height=64;
                        const x=c.getContext('2d'); x.font="30px Arial"; x.fillStyle="#0f0"; x.textAlign="center"; x.fillText(p.name,128,40);
                        const s=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(c)}));
                        s.position.y=25; s.scale.set(20,5,1); g.add(s);
                        
                        scene.add(g);
                        otherPlayers[docSnap.id] = { mesh: g, tPos: new THREE.Vector3(p.x,p.y,p.z), tRot: p.ry };
                        g.position.set(p.x,p.y,p.z);
                        log("NEW PLAYER JOINED: " + p.name);
                    } else {
                        // Update Player
                        otherPlayers[docSnap.id].tPos.set(p.x, p.y, p.z);
                        otherPlayers[docSnap.id].tRot = p.ry;
                    }
                });

                // Cleanup
                for(let id in otherPlayers) {
                    if(!snap.docs.find(d=>d.id===id)) {
                        scene.remove(otherPlayers[id].mesh); delete otherPlayers[id];
                        log("Player Left");
                    }
                }
                
                // Update Debug Text
                debugBox.innerText = `ID: ${myId}\nONLINE: ${count}\n(Uploading...)`;

                // Trigger Timer
                if(count >= 2 && !startTime && isPlaying) updateDoc(gameRef, {start:Date.now()}).catch(e=>{});
            });

            // C. UPLOAD SELF
            setInterval(() => {
                if(isPlaying) {
                    setDoc(doc(db, colName, myId), {
                        x:camera.position.x, y:camera.position.y-10, z:camera.position.z,
                        ry:camera.rotation.y, name:myName, time:Date.now()
                    }).catch(e => log("UPLOAD FAIL: " + e.message));
                }
            }, 100);
        }

        document.getElementById('clap-btn').addEventListener('click', () => {
            updateDoc(doc(db, "gamestate", "room_master_final"), {matrix:true});
        });

        // 8. INPUTS
        let joyId=null, lookId=null;
        let move={x:0,y:0}, lastLook={x:0,y:0};
        const jStick = document.getElementById('joy-stick');
        const jBase = document.getElementById('joy-base');

        const zMove = document.getElementById('zone-move');
        zMove.addEventListener('touchstart', e=>{e.preventDefault(); joyId=e.changedTouches[0].identifier; updateJoy(e.changedTouches[0]);},{passive:false});
        zMove.addEventListener('touchmove', e=>{e.preventDefault(); for(let t of e.changedTouches) if(t.identifier===joyId) updateJoy(t);},{passive:false});
        zMove.addEventListener('touchend', e=>{for(let t of e.changedTouches) if(t.identifier===joyId) {joyId=null; move={x:0,y:0}; jStick.style.transform="translate(-50%,-50%)";}});

        function updateJoy(t) {
            const r = jBase.getBoundingClientRect();
            const cx = r.left+r.width/2, cy = r.top+r.height/2;
            let dx = t.clientX-cx, dy = t.clientY-cy;
            const d = Math.min(Math.sqrt(dx*dx+dy*dy), 60);
            const a = Math.atan2(dy,dx);
            dx=Math.cos(a)*d; dy=Math.sin(a)*d;
            jStick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            move.x=dx/60; move.y=dy/60;
        }

        const zLook = document.getElementById('zone-look');
        zLook.addEventListener('touchstart', e=>{e.preventDefault(); lookId=e.changedTouches[0].identifier; lastLook={x:e.changedTouches[0].clientX, y:e.changedTouches[0].clientY};},{passive:false});
        zLook.addEventListener('touchmove', e=>{
            e.preventDefault();
            for(let t of e.changedTouches) if(t.identifier===lookId) {
                camera.rotation.y -= (t.clientX - lastLook.x)*0.005;
                camera.rotation.x -= (t.clientY - lastLook.y)*0.005;
                lastLook={x:t.clientX, y:t.clientY};
            }
        },{passive:false});
        zLook.addEventListener('touchend', e=>{for(let t of e.changedTouches) if(t.identifier===lookId) lookId=null;});

        // 9. LOOP
        camera.position.set(0,0,100);
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            const now = clock.getElapsedTime();

            if(isMatrix) matUniforms.iTime.value = now;

            // Move Self
            if(move.x!==0 || move.y!==0) {
                const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0),camera.rotation.y);
                const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0),camera.rotation.y);
                camera.position.addScaledVector(fwd, -move.y*4);
                camera.position.addScaledVector(rgt, move.x*4);
                camera.position.x = Math.max(-190, Math.min(190, camera.position.x));
                camera.position.z = Math.max(-190, Math.min(190, camera.position.z));
            }

            // Move Others (Interpolate)
            for(let id in otherPlayers) {
                const p = otherPlayers[id];
                p.mesh.position.lerp(p.tPos, 0.1);
                p.mesh.rotation.y += (p.tRot - p.mesh.rotation.y)*0.1;
            }

            // Timer
            if(startTime && !isMatrix) {
                const elap = Date.now() - startTime;
                const rem = Math.ceil((30000 - elap)/1000);
                if(rem > 0) document.getElementById('timer').innerText = `00:${rem.toString().padStart(2,'0')}`;
                else {
                    document.getElementById('timer').innerText = "TIME UP";
                    document.getElementById('clap-btn').style.display='block';
                }
            }

            renderer.render(scene, camera);
        }
        animate();
        
        window.addEventListener('beforeunload', ()=>deleteDoc(doc(db, "players_master_final", myId)));

    </script>
</body>
</html>
